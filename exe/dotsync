#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/dotsync"
require "optparse"

options = { apply: false, config_path: nil }

opt_parser = OptionParser.new do |opts|
  opts.banner = <<~BANNER
    dotsync #{Dotsync::VERSION}
    Usage: dotsync [command] [options]

    Commands:
      push   Upload local changes to the remote
      pull   Download remote changes to the local
      watch  Continuously monitor and sync changes
      setup  Initialize a default configuration file

Options:
  -a, --apply           Apply changes (push or pull)
  --dry-run             Preview changes without applying (default behavior)
  -y, --yes             Skip confirmation prompt (auto-confirm)
  -c, --config PATH     Specify custom config file path
  -q, --quiet           Hide all non-essential output (only errors or final status)
  --no-legend           Hide all legends for config, mappings, and differences
  --no-config           Hide the config section in the output
  --no-mappings         Hide the mappings and their legend
  --no-diff-legend      Hide the differences legend only
  --no-diff             Hide the differences section itself
  --only-diff           Show only the differences section
  --only-config         Show only the config section
  --only-mappings       Show only the mappings section
  -v, --verbose         Force showing all available information
  --version             Show version number
  -h, --help            Show this help message
  BANNER

  opts.on("-a", "--apply", "Apply changes") do
    options[:apply] = true
  end

  opts.on("--dry-run", "Preview changes without applying (default behavior)") do
    options[:apply] = false
  end

  opts.on("-y", "--yes", "Skip confirmation prompt (auto-confirm)") do
    options[:yes] = true
  end

  opts.on("-c", "--config PATH", "Specify custom config file path") do |path|
    options[:config_path] = path
  end

  opts.on("-q", "--quiet", "Hide all non-essential output (only errors or final status)") do
    options[:quiet] = true
  end

  opts.on("--no-legend", "Hide all legends for config, mappings, and differences") do
    options[:no_legend] = true
  end

  opts.on("--no-config", "Hide the config section in the output") do
    options[:no_config] = true
  end

  opts.on("--no-mappings", "Hide the mappings and their legend") do
    options[:no_mappings] = true
  end

  opts.on("--no-diff-legend", "Hide the differences legend only") do
    options[:no_diff_legend] = true
  end

  opts.on("--no-diff", "Hide the differences section itself") do
    options[:no_diff] = true
  end

  opts.on("--only-diff", "Show only the differences section") do
    options[:only_diff] = true
  end

  opts.on("--only-config", "Show only the config section") do
    options[:only_config] = true
  end

  opts.on("--only-mappings", "Show only the mappings section") do
    options[:only_mappings] = true
  end

  opts.on("-v", "--verbose", "Force showing all available information") do
    options[:verbose] = true
  end

  opts.on("--version", "Show version number") do
    puts "dotsync #{Dotsync::VERSION}"
    exit
  end

  opts.on("-h", "--help", "Show this help message") do
    puts opt_parser.banner
    exit
  end
end

opt_parser.parse!

command = ARGV.shift

case command
when "push"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:push, options)
when "pull"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:pull, options)
when "watch"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:watch, options)
when "setup"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:setup)
else
  if command
    puts "dotsync: no such command '#{command}'"
  else
    puts opt_parser.banner
  end
  exit 1
end
