#!/usr/bin/env ruby
# frozen_string_literal: true

require "optparse"
require_relative "../lib/dotsync/version"

options = { apply: false, config_path: nil }

# Initialize logger early for consistent error handling
require_relative "../lib/dotsync/core"
logger = Dotsync::Logger.new

opt_parser = OptionParser.new do |opts|
  opts.banner = <<~BANNER
    dotsync #{Dotsync::VERSION}
    Usage: dotsync [command] [options]

    Commands:
      push     Upload local changes to the remote
      pull     Download remote changes to the local
      watch    Continuously monitor and sync changes
      setup    Initialize a default configuration file
      init     Alias for 'setup'
      status   Show current configuration and mappings
      diff     Show differences (alias for 'push' without --apply)

    Examples:
      dotsync setup                      # Create initial config file
      dotsync push                       # Preview changes (dry-run)
      dotsync push --apply               # Apply changes to remote
      dotsync push -ay                   # Apply without confirmation
      dotsync pull --quiet               # Pull with minimal output
      dotsync status                     # Show current setup
      dotsync diff                       # Show what would change
      dotsync watch                      # Monitor and sync continuously
      dotsync -c ~/custom.toml push      # Use custom config file
      dotsync push --trace               # Show full error backtraces

    Options:
      -a, --apply           Apply changes (push or pull)
      --dry-run             Preview changes without applying (default behavior)
      -y, --yes             Skip confirmation prompt (auto-confirm)
      -c, --config PATH     Specify custom config file path
      -q, --quiet           Hide all non-essential output (only errors or final status)
      --no-legend           Hide all legends for config, mappings, and differences
      --no-config           Hide the config section in the output
      --no-mappings         Hide the mappings and their legend
      --no-diff-legend      Hide the differences legend only
      --no-diff             Hide the differences section itself
      --only-diff           Show only the differences section
      --only-config         Show only the config section
      --only-mappings       Show only the mappings section
      -v, --verbose         Force showing all available information
      --diff-content        Show git-like content diff for modified files
      --force-hooks         Run hooks even when no files changed
      --trace               Show full error backtraces (for debugging)
      --version             Show version number
      -h, --help            Show this help message
  BANNER

  opts.on("-a", "--apply", "Apply changes") do
    options[:apply] = true
  end

  opts.on("--dry-run", "Preview changes without applying (default behavior)") do
    options[:apply] = false
  end

  opts.on("-y", "--yes", "Skip confirmation prompt (auto-confirm)") do
    options[:yes] = true
  end

  opts.on("-c", "--config PATH", "Specify custom config file path") do |path|
    options[:config_path] = path
  end

  opts.on("-q", "--quiet", "Hide all non-essential output (only errors or final status)") do
    options[:quiet] = true
  end

  opts.on("--no-legend", "Hide all legends for config, mappings, and differences") do
    options[:no_legend] = true
  end

  opts.on("--no-config", "Hide the config section in the output") do
    options[:no_config] = true
  end

  opts.on("--no-mappings", "Hide the mappings and their legend") do
    options[:no_mappings] = true
  end

  opts.on("--no-diff-legend", "Hide the differences legend only") do
    options[:no_diff_legend] = true
  end

  opts.on("--no-diff", "Hide the differences section itself") do
    options[:no_diff] = true
  end

  opts.on("--only-diff", "Show only the differences section") do
    options[:only_diff] = true
  end

  opts.on("--only-config", "Show only the config section") do
    options[:only_config] = true
  end

  opts.on("--only-mappings", "Show only the mappings section") do
    options[:only_mappings] = true
  end

  opts.on("-v", "--verbose", "Force showing all available information") do
    options[:verbose] = true
  end

  opts.on("--diff-content", "Show git-like content diff for modified files") do
    options[:diff_content] = true
  end

  opts.on("--force-hooks", "Run hooks even when no files changed") do
    options[:force_hooks] = true
  end

  opts.on("--trace", "Show full error backtraces (for debugging)") do
    options[:trace] = true
  end

  opts.on("--version", "Show version number") do
    puts "dotsync #{Dotsync::VERSION}"
    exit
  end

  opts.on("-h", "--help", "Show this help message") do
    puts opt_parser.banner
    exit
  end
end

begin
  opt_parser.parse!
rescue OptionParser::InvalidOption, OptionParser::InvalidArgument => e
  # Extract just the problematic option from the error message
  option_match = e.message.match(/invalid (?:option|argument): (.+)/)
  problem = option_match ? option_match[1] : e.message

  logger.error("Invalid option: #{problem}")
  logger.info("See 'dotsync --help' for available options")

  if options[:trace]
    logger.log("\nFull backtrace:", color: 240)
    e.backtrace.each { |line| logger.log("  #{line}", color: 240) }
  end

  exit 1
end

command = ARGV.shift

# Load only the dependencies needed for the specific command
begin
  case command
when "push"
  require_relative "../lib/dotsync/loaders/push_loader"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:push, options)
when "pull"
  require_relative "../lib/dotsync/loaders/pull_loader"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:pull, options)
when "watch"
  require_relative "../lib/dotsync/loaders/watch_loader"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:watch, options)
when "setup", "init"
  require_relative "../lib/dotsync/loaders/setup_loader"
  Dotsync::Runner.new(config_path: options[:config_path]).run(:setup)
when "status"
  require_relative "../lib/dotsync/loaders/push_loader"
  # Show config and mappings without executing any action
  # Use push action with only-config and only-mappings to display info
  status_options = options.merge(
    only_config: true,
    only_mappings: true,
    no_diff: true,
    apply: false
  )
  Dotsync::Runner.new(config_path: options[:config_path]).run(:push, status_options)
when "diff"
  require_relative "../lib/dotsync/loaders/push_loader"
  # Alias for push in preview mode (default behavior)
  diff_options = options.merge(apply: false)
  Dotsync::Runner.new(config_path: options[:config_path]).run(:push, diff_options)
else
  if command
    logger.error("Unknown command: '#{command}'")
    logger.info("See 'dotsync --help' for available commands")
  else
    puts opt_parser.banner
  end
  exit 1
  end
rescue => e
  logger.error("Unexpected error: #{e.message}")

  if options[:trace]
    logger.log("\nFull backtrace:", color: 240)
    e.backtrace.each { |line| logger.log("  #{line}", color: 240) }
  else
    logger.info("Run with --trace to see full error details")
  end

  exit 1
end
